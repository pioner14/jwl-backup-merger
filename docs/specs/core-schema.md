# spec://core/schema

## Валидация схемы базы данных

**Версия**: 1.0  
**Статус**: stable  
**Модуль**: `jwl_backup_merger.py::validate_database_schema()`

---

## Назначение

Компонент проверяет, что база данных JW Library содержит все требуемые таблицы перед слиянием.

---

## Whitelist таблиц

```python
ALLOWED_TABLES = frozenset({
    'Note',       # Заметки
    'UserMark',   # Выделения
    'Location',   # Местоположения
    'Tag',        # Теги
    'TagMap',     # Связи тегов
    'Bookmark',   # Закладки
    'BlockRange'  # Диапазоны блоков
})
```

**Обоснование**: `frozenset` обеспечивает неизменяемость и эффективность проверки принадлежности.

---

## Контракт

```python
def validate_database_schema(db_path: Path) -> Tuple[bool, List[str], str]:
    """
    Проверяет схему базы данных на наличие требуемых таблиц.
    
    Args:
        db_path: Путь к файлу базы данных
    
    Returns:
        Кортеж (is_valid, missing_tables, message):
            - is_valid: True если все таблицы присутствуют
            - missing_tables: Список отсутствующих таблиц
            - message: Человекочитаемое сообщение
    """
```

---

## Алгоритм

```
1. Подключиться к SQLite
2. Получить список всех таблиц из sqlite_master
3. Для каждой таблицы из ALLOWED_TABLES:
   - Если таблица отсутствует, добавить в missing_tables
4. Если missing_tables не пуст:
   - Вернуть (False, missing_tables, "Отсутствуют таблицы: ...")
5. Иначе:
   - Вернуть (True, [], "Схема базы данных валидна")
```

---

## Обработка ошибок

| Ошибка | Возврат |
|--------|---------|
| sqlite3.OperationalError | `(False, [], "Ошибка при проверке схемы: {message}")` |
| FileNotFoundError | `(False, [], "Файл базы данных не найден")` |

---

## Интеграция с merge

Валидация выполняется **перед** слиянием:

```python
is_valid, missing, message = validate_database_schema(db_path)
if not is_valid:
    logger.warning(f"Архив {archive_path} имеет невалидную схему: {message}")
    # Пропустить архив или продолжить с предупреждением
```

**Решение**: Не прерывать слияние при невалидной схеме, но логировать предупреждение.

**Обоснование**: Пользователь может объединять бэкапы из разных версий JW Library с разными схемами.

---

## Расширения (TODO)

### Версионирование схемы

```python
SCHEMA_VERSIONS = {
    '1.0': {'tables': {...}, 'columns': {...}},
    '2.0': {'tables': {...}, 'columns': {...}},
}
```

**Проблема**: Разные версии JW Library могут иметь разные схемы.

**Решение (планируется)**: Определять версию схемы и адаптировать логику слияния.

---

## Тесты

См. `spec://test/integration#TestValidateDatabaseSchema`

---

## История изменений

| Версия | Дата | Изменение |
|--------|------|-----------|
| 1.0 | 2026-02-26 | Initial spec |
