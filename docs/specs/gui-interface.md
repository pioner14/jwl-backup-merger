# spec://gui/interface

## Графический интерфейс пользователя

**Версия**: 1.0  
**Статус**: new  
**Модуль**: `jwl_backup_merger_gui.py`

---

## Назначение

Простой графический интерфейс для объединения бэкапов JW Library без использования командной строки.

---

## Требования

- **Кроссплатформенность**: Windows, macOS, Linux
- **Минимум зависимостей**: только стандартная библиотека Python (tkinter)
- **Простота**: 3 шага для пользователя

---

## Интерфейс

### Основное окно

```
┌─────────────────────────────────────────────────────────────┐
│  JW Library Backup Merger                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. Выберите папку с бэкапами:                              │
│     ┌────────────────────────────────────┐ ┌───────────┐   │
│     │ /path/to/backups                   │ │ Обзор...  │   │
│     └────────────────────────────────────┘ └───────────┘   │
│                                                             │
│  2. Найдено архивов: 4                                      │
│     ├─ UserDataBackup_2026-02-22_Alenka.jwlibrary          │
│     ├─ UserdataBackup_2026-02-22_DESKTOP...                │
│     ├─ UserdataBackup_2026-02-22_Xiaomi...                 │
│     └─ UserdataBackup_2026-02-23_Samsung...                │
│                                                             │
│  3. Выходной файл:                                          │
│     ┌────────────────────────────────────┐ ┌───────────┐   │
│     │ combined_backup.jwlibrary          │ │ Обзор...  │   │
│     └────────────────────────────────────┘ └───────────┘   │
│                                                             │
│     ┌─────────────────────────────────────────────────┐     │
│     │ [x] Открыть папку после завершения              │     │
│     └─────────────────────────────────────────────────┘     │
│                                                             │
│                    ┌─────────────────┐                      │
│                    │   Объединить    │                      │
│                    └─────────────────┘                      │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  Готово к работе                                            │
│  ████████████████████████████░░░░░░░░  75%                  │
└─────────────────────────────────────────────────────────────┘
```

---

## Компоненты

### 1. Выбор входной папки
- Кнопка "Обзор..." → диалог выбора папки
- Текстовое поле с полным путём
- Автообновление списка архивов при выборе

### 2. Список архивов
- Отображение найденных `.jwlibrary` файлов
- Количество записей в каждом (опционально)
- Подсветка проблемных файлов (ошибки чтения)

### 3. Выбор выходного файла
- Кнопка "Обзор..." → диалог сохранения
- По умолчанию: `combined_backup.jwlibrary` в текущей папке

### 4. Кнопка "Объединить"
- Запуск процесса слияния
- Блокировка на время выполнения
- Прогресс-бар

### 5. Строка состояния
- Текущий статус ("Готово", "Обработка...", "Ошибка")
- Прогресс-бар
- Детали (количество обработанных записей)

---

## Сценарии использования

### Сценарий 1: Успешное объединение
1. Пользователь выбирает папку с бэкапами
2. Список архивов обновляется (показано: "Найдено 4 архивов")
3. Пользователь выбирает выходной файл (или оставляет по умолчанию)
4. Нажимает "Объединить"
5. Прогресс-бар заполняется
6. Статус: "✅ Готово! 143,831 записей"
7. Папка с результатом открывается (если выбрана опция)

### Сценарий 2: Ошибка (нет архивов)
1. Пользователь выбирает пустую папку
2. Статус: "❌ Не найдено файлов .jwlibrary"
3. Кнопка "Объединить" неактивна

### Сценарий 3: Ошибка при слиянии
1. Пользователь нажимает "Объединить"
2. Происходит ошибка (например, нет места на диске)
3. Статус: "❌ Ошибка: нет места на диске"
4. Кнопка "Объединить" снова активна

---

## Технические детали

### Используемые модули
```python
import tkinter as tk
from tkinter import ttk, filedialog, messagebox
from pathlib import Path
import threading  # Для асинхронного выполнения
```

### Структура кода
```python
class BackupMergerGUI:
    def __init__(self, root):
        self.root = root
        self.setup_ui()
        self.archive_files = []
    
    def setup_ui(self):
        # Создание виджетов
        ...
    
    def browse_input_folder(self):
        # Диалог выбора папки
        ...
    
    def update_archive_list(self):
        # Обновление списка архивов
        ...
    
    def start_merge(self):
        # Запуск в отдельном потоке
        thread = threading.Thread(target=self.merge_worker)
        thread.start()
    
    def merge_worker(self):
        # Фактическое слияние (вызов jwl_backup_merger)
        ...
    
    def update_progress(self, value, status):
        # Обновление прогресс-бара (через after)
        ...
```

---

## Интеграция с основным модулем

GUI вызывает функции из `jwl_backup_merger.py`:
- `create_merged_db()` — слияние баз данных
- `create_manifest_from_archives()` — создание манифеста
- `create_backup_archive()` — создание финального архива

Логирование перенаправляется в GUI (текстовое поле или статус-бар).

---

## Сборка бинарников

### PyInstaller spec
Добавить новый spec файл для GUI:
```python
# jwl_backup_merger_gui.spec
exe = EXE(
    ...
    name='jwl-backup-merger-gui',
    icon='icon.ico',  # Иконка
    ...
)
```

### Workflow
Обновить `.github/workflows/build.yml`:
- `build-gui-linux`
- `build-gui-windows`
- `build-gui-macos`

---

## Тесты

### spec://test/gui
- `test_browse_input_folder` — выбор папки
- `test_update_archive_list` — обновление списка
- `test_start_merge` — запуск слияния
- `test_error_handling` — обработка ошибок

---

## История изменений

| Версия | Дата | Изменение |
|--------|------|-----------|
| 1.0 | 2026-02-26 | Initial spec |
