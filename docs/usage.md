# JW Library Backup Merger

Инструмент для объединения нескольких бэкапов JW Library в один инкрементарный бэкап с проверкой дубликатов и сохранением уникальных записей.

## Описание

JW Library Backup Merger - это инструмент командной строки, предназначенный для объединения нескольких архивов бэкапов JW Library (.jwlibrary) в один архив, содержащий все уникальные заметки, выделения, теги и закладки из всех входных архивов. Инструмент эффективно обнаруживает и исключает дубликаты, позволяя пользователю объединить исторические данные из разных устройств или временных периодов в один бэкап для импорта обратно в JW Library.

## Функции

- **Извлечение данных**: извлекает userData.db из архивов .jwlibrary
- **Объединение баз данных**: объединяет заметки, выделения, теги, закладки и другие данные из нескольких архивов
- **Дедупликация**: обнаруживает и исключает дубликаты на основе содержимого и метаданных
- **Обработка структурных различий**: корректно обрабатывает различия в структуре базы данных между разными версиями JW Library
- **Создание архива**: создает новый .jwlibrary файл, готовый к импорту в JW Library
- **Подсчет уникальных записей**: показывает статистику по объединенным данным
- **Проверка целостности**: убедывается, что созданный бэкап структурно корректен

## Установка

### Вариант 1: Установка с исходников

1. Скачайте исходный код:
```bash
git clone https://github.com/yourusername/jwl-backup-merger.git
cd jwl-backup-merger
```

2. Установите зависимости (опционально, если используете системный Python):
```bash
# Создание виртуального окружения (рекомендуется)
python3 -m venv venv
source venv/bin/activate  # На Linux/macOS
# или
venv\Scripts\activate  # На Windows

# Установка зависимостей (опционально, если используете PyInstaller)
pip install -r requirements.txt
```

3. Запустите скрипт:
```bash
python jwl_backup_merger.py
```

### Вариант 2: Использование как Python модуля

```bash
pip install .
```

### Вариант 3: Использование исполняемого файла (если доступен)

Если у вас есть бинарный файл, просто запустите его:

```bash
# Linux/macOS
./jwl-backup-merger input_directory/

# Windows
jwl-backup-merger.exe input_directory/
```

## Использование

### Основная команда

```bash
python jwl_backup_merger.py <путь_к_директории_с_архивами> [опции]
```

### Примеры

1. **Простое объединение**:
```bash
python jwl_backup_merger.py ./backups/
```
Создаст `combined_backup.jwlibrary` в текущей директории с объединёнными данными из всех .jwlibrary файлов в `./backups/`.

2. **Указание имени выходного файла**:
```bash
python jwl_backup_merger.py ./backups/ -o my_combined_backup.jwlibrary
```

3. **Указание директории вывода**:
```bash
python jwl_backup_merger.py ./backups/ --output-dir ./output/ -o backup.jwlibrary
```

### Опции командной строки

- `input_dir` - (обязательно) директория, содержащая .jwlibrary файлы для объединения
- `-o, --output` - имя выходного файла (по умолчанию: `combined_backup.jwlibrary`)
- `--output-dir` - директория для сохранения результата (по умолчанию: текущая директория)

## Поддерживаемые типы данных

Инструмент объединяет следующие типы данных из JW Library:

- **Заметки (Notes)** - с содержимым, заголовками и местоположением
- **Выделения (UserMarks)** - с цветовыми метками и стилями
- **Местоположения (Locations)** - книги, главы, публикации
- **Теги (Tags)** - пользовательские метки
- **Связи тегов (TagMaps)** - связи между тегами и другими элементами
- **Закладки (Bookmarks)** - сохранённые места в публикациях
- **Диапазоны блоков (BlockRanges)** - выделенные диапазоны текста

## Алгоритм дедупликации

Инструмент использует улучшенный алгоритм определения уникальности записей, который:

- Для **заметок**: проверяет сочетание содержимого, заголовка, местоположения, выделения и GUID
- Для **выделений**: использует GUID, если доступен, или комбинацию местоположения, цвета и стиля
- Для **других типов**: использует соответствующие комбинации полей, уникально идентифицирующих запись

Это позволяет корректно объединять данные из разных устройств и временных периодов, избегая дублирования действительно одинаковых записей.

## Совместимость

Созданные бэкапы полностью совместимы с JW Library и могут быть импортированы без ошибок "сохраненные данные повреждены". Инструмент:

- Сохраняет оригинальную структуру базы данных
- Обновляет манифест с корректной информацией
- Проверяет целостность данных
- Обрабатывает различия в схеме базы данных между версиями JW Library

## Требования

- **Python 3.6 или выше**
- **SQLite3** (обычно входит в стандартную библиотеку Python)
- **Стандартные библиотеки Python**: hashlib, json, zipfile, sqlite3, argparse

Для сборки бинарника дополнительно требуются:
- PyInstaller (для создания исполняемых файлов)

## Структура проекта

```
jwl-backup-merger/
├── jwl_backup_merger.py      # Основной скрипт
├── setup.sh                  # Скрипт установки для Linux/macOS
├── README.md                 # Этот файл
├── LICENSE                   # Лицензия
├── requirements.txt          # Зависимости
├── setup.py                  # Установка как пакета Python
├── jwl_backup_merger.spec    # Конфигурация PyInstaller
└── build_binary.sh           # Скрипт сборки бинарника
```

## Известные проблемы и ограничения

1. **Структурные различия**: Разные версии JW Library могут использовать разные схемы базы данных. Инструмент пытается обрабатывать эти различия, но в крайних случаях может игнорировать некоторые поля.

2. **Очень старые бэкапы**: Очень старые версии JW Library могут иметь несовместимую схему базы данных.

3. **Размер файлов**: Объединение многих больших бэкапов может создать большие результирующие файлы.

## Устранение неполадок

Если возникает ошибка "сохраненные данные повреждены" при импорте бэкапа:

1. Проверьте, что в бэкапе содержатся данные из всех ожидаемых таблиц
2. Убедитесь, что версия JW Library поддерживает типы данных в бэкапе
3. Попробуйте импортировать бэкап в новую установку JW Library

## Вклад в проект

Будем рады принять pull request'ы! Пожалуйста, следуйте следующим рекомендациям:

1. Создайте ветку для ваших изменений
2. Пишите чистый, документированный код
3. Обновляйте документацию по необходимости
4. Протестируйте изменения перед отправкой

## Лицензия

Данный проект лицензирован под MIT License - см. файл `LICENSE` для получения дополнительной информации.

## Автор

AI Assistant (на основе анализа и доработки исходного проекта)

## Благодарности

- Сообществу JW Library за предоставление данных для анализа
- Разработчикам Python за мощные инструменты работы с базами данных и архивами
- Специалистам по обратному инжинирингу в области резервного копирования приложений JW Library

---

Если вы нашли этот инструмент полезным, пожалуйста, поставьте звезду ⭐ этому репозиторию!