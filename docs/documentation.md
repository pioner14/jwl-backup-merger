# JW Library Backup Merger - Документация

## Содержание

1. [Введение](#введение)
2. [Функциональность](#функциональность)
3. [Архитектура проекта](#архитектура-проекта)
4. [Алгоритмы](#алгоритмы)
5. [Совместимость](#совместимость)

## Введение

JW Library Backup Merger - это инструмент командной строки, предназначен для объединения нескольких бэкапов JW Library (.jwlibrary) в один архив, содержащий все уникальные заметки, выделения, теги и закладки из всех входных архивов. Инструмент эффективно обнаруживает и исключает дубликаты, позволяя пользователю объединить исторические данные из разных устройств или временных периодов в один бэкап для импорта обратно в JW Library.

## Функциональность

### Основные функции
- Извлечение userData.db из архивов .jwlibrary
- Объединение баз данных с исключением дубликатов
- Создание нового архива для импорта в JW Library
- Поддержка всех типов данных (заметки, пометки, теги, закладки)
- Подсчет уникальных записей из всех архивов

### Поддерживаемые типы данных
- Заметки (Notes)
- Пометки (UserMarks) с цветовыми выделениями
- Местоположения (Locations)
- Теги (Tags)
- Связи тегов (TagMaps)
- Закладки (Bookmarks)
- Диапазоны блоков (BlockRanges)

## Архитектура проекта

### Файловая структура
```
jwl-backup-merger/
├── jwl_backup_merger.py     # Основной скрипт с логикой объединения
├── setup.sh                 # Скрипт установки для Linux/macOS
├── README.md                # Краткая документация
├── README_FULL.md           # Полная документация
├── requirements.txt         # Зависимости (если требуются)
├── setup.py                 # Установка как Python пакета
├── jwl_backup_merger.spec   # Конфигурация PyInstaller
├── build_binary.sh          # Скрипт сборки бинарника
├── LICENSE                  # Лицензия MIT
├── .gitignore               # Файлы для игнорирования Git
└── CONTRIBUTING.md          # Руководство для контрибьюторов
```

### Основные компоненты
- `generate_record_hash()` - функция для вычисления уникального хэша записи
- `extract_from_archive()` - функция для извлечения данных из .jwlibrary архива
- `create_merged_db()` - основная функция объединения баз данных
- `create_manifest_from_archives()` - функция создания нового манифеста
- `create_backup_archive()` - функция создания финального архива

## Алгоритмы

### Алгоритм дедупликации
Инструмент использует улучшенный алгоритм определения уникальности записей, который:

- Для заметок (Notes): проверяет сочетание содержимого, заголовка, местоположения, выделения и GUID
- Для выделений (UserMarks): использует GUID, если доступен, или комбинацию местоположения, цвета и стиля
- Для других типов данных: использует соответствующие комбинации полей, уникально идентифицирующих запись

### Обработка структурных различий
При объединении бэкапов из разных версий JW Library инструмент:

- Использует структуру первой базы данных как основу
- Игнорирует столбцы, которые отсутствуют в целевой базе
- Обрабатывает различия в схеме без критических ошибок

## Совместимость

Созданные бэкапы полностью совместимы с JW Library и могут быть импортированы без ошибок. Инструмент:

- Сохраняет оригинальную структуру базы данных
- Обновляет манифест с корректной информацией
- Проверяет целостность данных
- Обрабатывает различия в схеме базы данных между версиями JW Library